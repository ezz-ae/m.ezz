{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "displayName": {
          "type": "string",
          "description": "User's display name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user was created.",
          "format": "date-time"
        },
        "role": {
          "type": "string",
          "description": "User's role in the system (owner, guest, beta).",
          "format": "string"
        }
      },
      "required": [
        "id",
        "displayName",
        "email",
        "createdAt",
        "role"
      ]
    },
    "Notebook": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notebook",
      "type": "object",
      "description": "Represents a notebook (living intelligence document).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Notebook entity."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Notebook)"
        },
        "slug": {
          "type": "string",
          "description": "URL-friendly slug for the notebook (e.g., forgetence, notefullbook)."
        },
        "title": {
          "type": "string",
          "description": "Title of the notebook."
        },
        "description": {
          "type": "string",
          "description": "Description of the notebook."
        },
        "visibility": {
          "type": "string",
          "description": "Visibility of the notebook (public, private, unlisted)."
        },
        "tags": {
          "type": "array",
          "description": "Tags associated with the notebook.",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the notebook was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the notebook was last updated.",
          "format": "date-time"
        },
        "fctProfile": {
          "type": "string",
          "description": "FCT profile settings for the notebook, including fadeMode and maxBufferSize.",
          "format": "string"
        }
      },
      "required": [
        "id",
        "ownerId",
        "slug",
        "title",
        "description",
        "visibility",
        "tags",
        "createdAt",
        "updatedAt",
        "fctProfile"
      ]
    },
    "Note": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Note",
      "type": "object",
      "description": "Represents an atomic piece of input (text, thought, extract, transcript).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Note entity."
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N Note)"
        },
        "authorId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Note)"
        },
        "content": {
          "type": "string",
          "description": "Content of the note."
        },
        "source": {
          "type": "string",
          "description": "Source of the note (manual, import, transcript, ai)."
        },
        "sessionId": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N Note)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the note was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the note was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "notebookId",
        "authorId",
        "content",
        "source",
        "createdAt",
        "updatedAt"
      ]
    },
    "Concept": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Concept",
      "type": "object",
      "description": "Represents a normalized idea/meaning extracted from notes.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Concept entity."
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N Concept)"
        },
        "label": {
          "type": "string",
          "description": "Label for the concept."
        },
        "summary": {
          "type": "string",
          "description": "Summary of the concept."
        },
        "relatedNoteIds": {
          "type": "array",
          "description": "References to Notes. (Relationship: Note N:N Concept)",
          "items": {
            "type": "string"
          }
        },
        "frequency": {
          "type": "number",
          "description": "Frequency of the concept."
        },
        "returnRate": {
          "type": "number",
          "description": "Return rate of the concept."
        },
        "driftScore": {
          "type": "number",
          "description": "Drift score of the concept."
        },
        "persistenceScore": {
          "type": "number",
          "description": "Persistence score of the concept."
        }
      },
      "required": [
        "id",
        "notebookId",
        "label",
        "summary",
        "relatedNoteIds",
        "frequency",
        "returnRate",
        "driftScore",
        "persistenceScore"
      ]
    },
    "Pattern": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Pattern",
      "type": "object",
      "description": "Represents a recurring theme across multiple notebooks.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Pattern entity."
        },
        "label": {
          "type": "string",
          "description": "Label for the pattern."
        },
        "description": {
          "type": "string",
          "description": "Description of the pattern."
        },
        "notebookIds": {
          "type": "array",
          "description": "References to Notebooks. (Relationship: Notebook N:N Pattern)",
          "items": {
            "type": "string"
          }
        },
        "conceptIds": {
          "type": "array",
          "description": "References to Concepts. (Relationship: Concept N:N Pattern)",
          "items": {
            "type": "string"
          }
        },
        "globalFrequency": {
          "type": "number",
          "description": "Global frequency of the pattern."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the pattern was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the pattern was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "label",
        "description",
        "notebookIds",
        "conceptIds",
        "globalFrequency",
        "createdAt",
        "updatedAt"
      ]
    },
    "Session": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Session",
      "type": "object",
      "description": "Represents a time-bounded thinking/work session.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Session entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Session)"
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N Session)"
        },
        "startedAt": {
          "type": "string",
          "description": "Timestamp indicating when the session started.",
          "format": "date-time"
        },
        "endedAt": {
          "type": "string",
          "description": "Timestamp indicating when the session ended.",
          "format": "date-time"
        },
        "noteCount": {
          "type": "number",
          "description": "Number of notes created during the session."
        },
        "context": {
          "type": "string",
          "description": "Context of the session."
        }
      },
      "required": [
        "id",
        "userId",
        "notebookId",
        "startedAt",
        "noteCount",
        "context"
      ]
    },
    "LedgerEntry": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LedgerEntry",
      "type": "object",
      "description": "Represents a cognitive ledger line (reasoning trace).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the LedgerEntry entity."
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N LedgerEntry)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N LedgerEntry)"
        },
        "type": {
          "type": "string",
          "description": "Type of ledger entry (decision, reflection, transform, fade)."
        },
        "payload": {
          "type": "string",
          "description": "Payload associated with the ledger entry.",
          "format": "string"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the ledger entry was created.",
          "format": "date-time"
        },
        "hash": {
          "type": "string",
          "description": "Hash of the ledger entry."
        },
        "prevHash": {
          "type": "string",
          "description": "Hash of the previous ledger entry."
        }
      },
      "required": [
        "id",
        "notebookId",
        "type",
        "payload",
        "createdAt",
        "hash"
      ]
    },
    "Artifact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Artifact",
      "type": "object",
      "description": "Represents a forgetting artifact (compressed learning from decayed data).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Artifact entity."
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N Artifact)"
        },
        "sourceNoteIds": {
          "type": "array",
          "description": "References to Notes. (Relationship: Note N:N Artifact)",
          "items": {
            "type": "string"
          }
        },
        "schemaLabel": {
          "type": "string",
          "description": "Schema label for the artifact."
        },
        "summary": {
          "type": "string",
          "description": "Summary of the artifact."
        },
        "compressedAt": {
          "type": "string",
          "description": "Timestamp indicating when the artifact was compressed.",
          "format": "date-time"
        },
        "decayLevel": {
          "type": "number",
          "description": "Decay level of the artifact (0-1)."
        }
      },
      "required": [
        "id",
        "notebookId",
        "sourceNoteIds",
        "schemaLabel",
        "summary",
        "compressedAt",
        "decayLevel"
      ]
    },
    "Event": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Event",
      "type": "object",
      "description": "Represents an analytics/behavioral signal.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Event entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Event)"
        },
        "type": {
          "type": "string",
          "description": "Type of event (page_view, notebook_open, session_start, session_end, note_created)."
        },
        "path": {
          "type": "string",
          "description": "Path associated with the event."
        },
        "notebookId": {
          "type": "string",
          "description": "Reference to Notebook. (Relationship: Notebook 1:N Event)"
        },
        "ts": {
          "type": "string",
          "description": "Timestamp indicating when the event occurred.",
          "format": "date-time"
        },
        "meta": {
          "type": "string",
          "description": "Metadata associated with the event.",
          "format": "string"
        }
      },
      "required": [
        "id",
        "type",
        "ts"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Access is generally restricted to the user themselves, with admin overrides.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/notebooks/{notebookId}",
        "definition": {
          "entityName": "Notebook",
          "schema": {
            "$ref": "#/backend/entities/Notebook"
          },
          "description": "Stores notebooks. Visibility controls (public, private, unlisted) are enforced in rules. The `ownerId` is used for ownership checks.",
          "params": [
            {
              "name": "notebookId",
              "description": "The unique identifier for the notebook."
            }
          ]
        }
      },
      {
        "path": "/notebooks/{notebookId}/notes/{noteId}",
        "definition": {
          "entityName": "Note",
          "schema": {
            "$ref": "#/backend/entities/Note"
          },
          "description": "Stores notes within notebooks. Path-based ownership ensures only the notebook owner can create or modify notes. Includes denormalized 'ownerId' from the parent notebook for authorization independence.",
          "params": [
            {
              "name": "notebookId",
              "description": "The unique identifier for the parent notebook."
            },
            {
              "name": "noteId",
              "description": "The unique identifier for the note."
            }
          ]
        }
      },
      {
        "path": "/notebooks/{notebookId}/concepts/{conceptId}",
        "definition": {
          "entityName": "Concept",
          "schema": {
            "$ref": "#/backend/entities/Concept"
          },
          "description": "Stores concepts extracted from notes within a notebook. Access control follows the notebook's ownership. Includes denormalized 'ownerId' from the parent notebook for authorization independence.",
          "params": [
            {
              "name": "notebookId",
              "description": "The unique identifier for the parent notebook."
            },
            {
              "name": "conceptId",
              "description": "The unique identifier for the concept."
            }
          ]
        }
      },
      {
        "path": "/patterns/{patternId}",
        "definition": {
          "entityName": "Pattern",
          "schema": {
            "$ref": "#/backend/entities/Pattern"
          },
          "description": "Stores patterns. These are global and may need separate access controls based on admin roles or visibility.",
          "params": [
            {
              "name": "patternId",
              "description": "The unique identifier for the pattern."
            }
          ]
        }
      },
      {
        "path": "/sessions/{sessionId}",
        "definition": {
          "entityName": "Session",
          "schema": {
            "$ref": "#/backend/entities/Session"
          },
          "description": "Stores session data. Access is restricted to the user who created the session, using `userId`.",
          "params": [
            {
              "name": "sessionId",
              "description": "The unique identifier for the session."
            }
          ]
        }
      },
      {
        "path": "/ledgerEntries/{ledgerEntryId}",
        "definition": {
          "entityName": "LedgerEntry",
          "schema": {
            "$ref": "#/backend/entities/LedgerEntry"
          },
          "description": "Stores ledger entries for tracking cognitive transformations. Access is restricted to the notebook owner.",
          "params": [
            {
              "name": "ledgerEntryId",
              "description": "The unique identifier for the ledger entry."
            }
          ]
        }
      },
      {
        "path": "/artifacts/{artifactId}",
        "definition": {
          "entityName": "Artifact",
          "schema": {
            "$ref": "#/backend/entities/Artifact"
          },
          "description": "Stores forgetting artifacts. Access is restricted to the notebook owner.",
          "params": [
            {
              "name": "artifactId",
              "description": "The unique identifier for the artifact."
            }
          ]
        }
      },
      {
        "path": "/events/{eventId}",
        "definition": {
          "entityName": "Event",
          "schema": {
            "$ref": "#/backend/entities/Event"
          },
          "description": "Stores analytics events. These are generally public write, but read access may be restricted to admins.",
          "params": [
            {
              "name": "eventId",
              "description": "The unique identifier for the event."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the EZZ.AE application, focusing on notebooks, notes, cognitive patterns, and user-specific data.  It prioritizes Authorization Independence by denormalizing ownership and roles where necessary, and enabling secure list operations via structural segregation. Access control is managed primarily via path-based ownership and visibility flags. \n\n*   **Users:** `/users/{userId}`: Stores user profiles. Access is generally restricted to the user themselves, with admin overrides.\n*   **Notebooks:** `/notebooks/{notebookId}`: Stores notebooks.  Visibility controls (public, private, unlisted) are enforced in rules. The `ownerId` is used for ownership checks.\n*   **Notes:** `/notebooks/{notebookId}/notes/{noteId}`: Stores notes within notebooks. Path-based ownership ensures only the notebook owner can create or modify notes.\n*   **Concepts:** `/notebooks/{notebookId}/concepts/{conceptId}`: Stores concepts extracted from notes within a notebook.  Access control follows the notebook's ownership.\n*   **Patterns:** `/patterns/{patternId}`: Stores patterns.  These are global and may need separate access controls based on admin roles or visibility.\n*   **Sessions:** `/sessions/{sessionId}`: Stores session data. Access is restricted to the user who created the session, using `userId`.\n*   **Ledger Entries:** `/ledgerEntries/{ledgerEntryId}`: Stores ledger entries for tracking cognitive transformations. Access is restricted to the notebook owner.\n*   **Artifacts:** `/artifacts/{artifactId}`: Stores forgetting artifacts. Access is restricted to the notebook owner.\n*   **Events:** `/events/{eventId}`: Stores analytics events.  These are generally public write, but read access may be restricted to admins.\n\n\n**Authorization Independence (CRITICAL):**\n\n*   **Notebooks:** The `notebooks` collection stores the `ownerId` directly within each document, eliminating the need for security rules to fetch user data for authorization.\n*   **Subcollections (notes, concepts, etc.):**  Since these are nested under `/notebooks/{notebookId}`, the security rules can easily verify if `request.auth.uid == resource.data.ownerId` from the parent `notebooks` collection without needing a `get()` call.\n*   **Patterns and LedgerEntries** Since ledger entries and patterns don't inherently belong to a specific user, the rules enforce stricter controls based on existence or admin roles.\n\n\n**QAPs (Rules are not Filters):**\n\n*   The structure enables secure `list` operations by leveraging the `visibility` field in the `notebooks` collection.  Rules can allow public reads for notebooks where `visibility == 'public'` without additional filtering.\n*   Path-based ownership in subcollections ensures that listing notes or concepts requires the user to be the owner of the parent notebook.\n*   For collections like `patterns`, which might have global visibility, separate rules with admin roles or specific visibility attributes can be implemented to control list access securely."
  }
}